      ###################################################################################
     #  Bed Mesh Leveling Macro For Caribou Printers Running Klipper
    # 
   #  This Start Script Is Highly Inspired By:
  #  Manuel Fichtner, Cryd-S
 #  Dr. Wolfgang Schadow, Caribou3d Research & Development
###################################################################################

[gcode_macro CK_BED_MESH]
gcode:
  ## Set Extruder To Relative Mode ##
  M83                                                         ; Use Relative Distances For Extrusion
  
  ## Heating Up Components For Leveling ##
  M117 Setting Heat Bed Temperature For Leveling!             ; Display Message
  {action_respond_info("Setting Heat Bed Temperature For Leveling!")}
  M140 S50                                                    ; Heat Bed 50°C
  M117 Setting Extruder Temperature For Leveling And Wait!    ; Display Message
  {action_respond_info("Setting Extruder Temperature For Leveling And Wait!")}
  M109 S150                                                   ; Extruder 150°C

  ## Check If Axes Are Homed ##
  {% if "xyz" not in printer.toolhead.homed_axes %}
      M117 Homing XYZ!                                        ; Display Message
      {action_respond_info("Homing XYZ!")}
      G28                                                     ; Homing XYZ
  {% else %}
      M117 All Axes Are Homed!                                ; Display Message
      {action_respond_info("All Axes Are Homed!")}
  {% endif %}

  ## Check If Z-Tilt Was Initiated ##
  {% if printer['z_tilt'].applied == false %}
      M117 Performing Z-Tilt!                                 ; Display Message
      {action_respond_info("Performing Z-Tilt!")}
      Z_TILT_ADJUST                                           ; Z-Tilt Adjust
      M117 Homing Z Axis Again!                               ; Display Message
      {action_respond_info("Homing Z Axis Again!")}
      G28 Z                                                   ; Homing Z After Z-Tilt
  {% else %}
      M117 Z-Tilt Already Active!                             ; Display Message
      {action_respond_info("Z-Tilt Already Active!")}
  {% endif %}

  ## Bed Mesh Leveling ##
  BED_MESH_CLEAR                                              ; Clear Mesh State
  BED_MESH_CALIBRATE PROFILE="CK_START"                       ; Start Bed Mesh Leveling And Create A Profile ...
  # BED_MESH_PROFILE LOAD="DEFAULT"                           ; ... OR: Load An Exisiting Profile